name: Publish to Crates.io

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  publish:
    name: Publish to Crates.io
    runs-on: ubuntu-latest
    environment: release # Optional: for enhanced security
    permissions:
      id-token: write # Required for OIDC token exchange
      contents: read # Required for reading repository contents

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–å½“å‰æ ‡ç­¾
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆ changelog
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## ğŸ‰ æ–°åŠŸèƒ½" > release_notes.md
            echo "" >> release_notes.md
            echo "### ğŸ“‹ æ›´æ–°å†…å®¹" >> release_notes.md
            echo "" >> release_notes.md
            
            # è·å–æäº¤ä¿¡æ¯å¹¶æ ¼å¼åŒ–
            git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | \
            sed 's/^feat: /âœ¨ /' | \
            sed 's/^fix: /ğŸ› /' | \
            sed 's/^chore: /ğŸ”§ /' | \
            sed 's/^refactor: /â™»ï¸ /' | \
            sed 's/^docs: /ğŸ“š /' | \
            sed 's/^style: /ğŸ’„ /' | \
            sed 's/^test: /ğŸ§ª /' | \
            sed 's/^perf: /âš¡ /' | \
            sed 's/^ci: /ğŸ‘· /' | \
            sed 's/^build: /ğŸ“¦ /' | \
            sed 's/^revert: /âª /' >> release_notes.md
            
            echo "" >> release_notes.md
            echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> release_notes.md
            echo "- [GitHub Repository](https://github.com/jenkinpan/pkg-checker-rs)" >> release_notes.md
            echo "- [Crates.io](https://crates.io/crates/pkg-checker)" >> release_notes.md
            echo "- [Documentation](https://docs.rs/pkg-checker)" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ğŸ“¦ å®‰è£…" >> release_notes.md
            echo "" >> release_notes.md
            echo "\`\`\`bash" >> release_notes.md
            echo "cargo install pkg-checker" >> release_notes.md
            echo "\`\`\`" >> release_notes.md
          else
            echo "## ğŸ‰ é¦–æ¬¡å‘å¸ƒ" > release_notes.md
            echo "" >> release_notes.md
            echo "pkg-checker æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å·¥å…·ï¼Œç”¨äºæ£€æŸ¥å’Œç®¡ç†å…¨å±€å®‰è£…çš„ Cargo åŒ…æ›´æ–°ã€‚" >> release_notes.md
            echo "" >> release_notes.md
            echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> release_notes.md
            echo "- ğŸ” è‡ªåŠ¨æ£€æµ‹å·²å®‰è£…çš„å…¨å±€ Cargo åŒ…" >> release_notes.md
            echo "- ğŸ“¦ æ£€æŸ¥æ¯ä¸ªåŒ…çš„æœ€æ–°ç‰ˆæœ¬" >> release_notes.md
            echo "- ğŸ¨ å½©è‰²è¾“å‡ºï¼Œæ¸…æ™°æ˜¾ç¤ºæ›´æ–°çŠ¶æ€" >> release_notes.md
            echo "- âš¡ å¼‚æ­¥å¤„ç†ï¼Œå¿«é€Ÿæ£€æŸ¥å¤šä¸ªåŒ…" >> release_notes.md
            echo "- ğŸ”„ é»˜è®¤äº¤äº’å¼æ›´æ–°æ¨¡å¼ï¼Œä¸€é”®æ›´æ–°åŒ…" >> release_notes.md
            echo "- ğŸ§  æ™ºèƒ½é¢„å‘å¸ƒç‰ˆæœ¬æ£€æµ‹å’Œè¯¢é—®" >> release_notes.md
            echo "- ğŸ“‹ è¯¦ç»†çš„æ›´æ–°æ‘˜è¦åŠŸèƒ½" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ğŸ“¦ å®‰è£…" >> release_notes.md
            echo "" >> release_notes.md
            echo "\`\`\`bash" >> release_notes.md
            echo "cargo install pkg-checker" >> release_notes.md
            echo "\`\`\`" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ğŸ”— ç›¸å…³é“¾æ¥" >> release_notes.md
            echo "- [GitHub Repository](https://github.com/jenkinpan/pkg-checker-rs)" >> release_notes.md
            echo "- [Crates.io](https://crates.io/crates/pkg-checker)" >> release_notes.md
            echo "- [Documentation](https://docs.rs/pkg-checker)" >> release_notes.md
          fi

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --workspace

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Run clippy
        run: cargo clippy --workspace -- -D warnings

      - name: Clean working directory
        run: |
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f release_notes.md
          # ç¡®ä¿å·¥ä½œç›®å½•å¹²å‡€
          git status --porcelain

      - name: Publish to Crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to Crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

      - name: Upload release notes
        run: |
          echo "Crates.io publish completed successfully!"
          echo "Tag: ${{ steps.changelog.outputs.current_tag }}"
          echo "Previous tag: ${{ steps.changelog.outputs.previous_tag }}"
          echo ""
          echo "Package published to crates.io: https://crates.io/crates/pkg-checker"
