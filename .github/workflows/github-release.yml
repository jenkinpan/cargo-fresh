name: Create GitHub Release

on:
  push:
    tags:
      - "v*" # å½“æŽ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for creating releases
      pull-requests: write # Required for release operations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # èŽ·å–å®Œæ•´çš„ git åŽ†å²

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Generate changelog
        id: changelog
        run: |
          # èŽ·å–å½“å‰æ ‡ç­¾
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT

          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

          # ç”Ÿæˆ changelog
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## ðŸŽ‰ æ–°åŠŸèƒ½" > release_notes.md
            echo "" >> release_notes.md
            echo "### ðŸ“‹ æ›´æ–°å†…å®¹" >> release_notes.md
            echo "" >> release_notes.md
            
            # èŽ·å–æäº¤ä¿¡æ¯å¹¶æ ¼å¼åŒ–
            git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | \
            sed 's/^feat: /âœ¨ /' | \
            sed 's/^fix: /ðŸ› /' | \
            sed 's/^chore: /ðŸ”§ /' | \
            sed 's/^refactor: /â™»ï¸ /' | \
            sed 's/^docs: /ðŸ“š /' | \
            sed 's/^style: /ðŸ’„ /' | \
            sed 's/^test: /ðŸ§ª /' | \
            sed 's/^perf: /âš¡ /' | \
            sed 's/^ci: /ðŸ‘· /' | \
            sed 's/^build: /ðŸ“¦ /' | \
            sed 's/^revert: /âª /' >> release_notes.md
            
            echo "" >> release_notes.md
            echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> release_notes.md
            echo "- [GitHub Repository](https://github.com/jenkinpan/pkg-checker-rs)" >> release_notes.md
            echo "- [Crates.io](https://crates.io/crates/pkg-checker)" >> release_notes.md
            echo "- [Documentation](https://docs.rs/pkg-checker)" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ðŸ“¦ å®‰è£…" >> release_notes.md
            echo "" >> release_notes.md
            echo "\`\`\`bash" >> release_notes.md
            echo "cargo install pkg-checker" >> release_notes.md
            echo "\`\`\`" >> release_notes.md
          else
            echo "## ðŸŽ‰ é¦–æ¬¡å‘å¸ƒ" > release_notes.md
            echo "" >> release_notes.md
            echo "pkg-checker æ˜¯ä¸€ä¸ªç”¨ Rust ç¼–å†™çš„å·¥å…·ï¼Œç”¨äºŽæ£€æŸ¥å’Œç®¡ç†å…¨å±€å®‰è£…çš„ Cargo åŒ…æ›´æ–°ã€‚" >> release_notes.md
            echo "" >> release_notes.md
            echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> release_notes.md
            echo "- ðŸ” è‡ªåŠ¨æ£€æµ‹å·²å®‰è£…çš„å…¨å±€ Cargo åŒ…" >> release_notes.md
            echo "- ðŸ“¦ æ£€æŸ¥æ¯ä¸ªåŒ…çš„æœ€æ–°ç‰ˆæœ¬" >> release_notes.md
            echo "- ðŸŽ¨ å½©è‰²è¾“å‡ºï¼Œæ¸…æ™°æ˜¾ç¤ºæ›´æ–°çŠ¶æ€" >> release_notes.md
            echo "- âš¡ å¼‚æ­¥å¤„ç†ï¼Œå¿«é€Ÿæ£€æŸ¥å¤šä¸ªåŒ…" >> release_notes.md
            echo "- ðŸ”„ é»˜è®¤äº¤äº’å¼æ›´æ–°æ¨¡å¼ï¼Œä¸€é”®æ›´æ–°åŒ…" >> release_notes.md
            echo "- ðŸ§  æ™ºèƒ½é¢„å‘å¸ƒç‰ˆæœ¬æ£€æµ‹å’Œè¯¢é—®" >> release_notes.md
            echo "- ðŸ“‹ è¯¦ç»†çš„æ›´æ–°æ‘˜è¦åŠŸèƒ½" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ðŸ“¦ å®‰è£…" >> release_notes.md
            echo "" >> release_notes.md
            echo "\`\`\`bash" >> release_notes.md
            echo "cargo install pkg-checker" >> release_notes.md
            echo "\`\`\`" >> release_notes.md
            echo "" >> release_notes.md
            echo "## ðŸ”— ç›¸å…³é“¾æŽ¥" >> release_notes.md
            echo "- [GitHub Repository](https://github.com/jenkinpan/pkg-checker-rs)" >> release_notes.md
            echo "- [Crates.io](https://crates.io/crates/pkg-checker)" >> release_notes.md
            echo "- [Documentation](https://docs.rs/pkg-checker)" >> release_notes.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.changelog.outputs.current_tag }}
          name: pkg-checker ${{ steps.changelog.outputs.current_tag }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release notes
        run: |
          echo "GitHub Release created successfully!"
          echo "Tag: ${{ steps.changelog.outputs.current_tag }}"
          echo "Previous tag: ${{ steps.changelog.outputs.previous_tag }}"
          echo ""
          echo "Release notes content:"
          cat release_notes.md
